"use strict";(self["webpackChunkoci_help_web"]=self["webpackChunkoci_help_web"]||[]).push([[815],{5815:function(e,t,s){s.r(t),s.d(t,{default:function(){return g}});var n=s(6768),o=s(4232);const i={key:0,style:{color:"#ffdd00"}};function l(e,t,s,l,c,r){const a=(0,n.g2)("el-scrollbar");return(0,n.uX)(),(0,n.Wv)(a,{class:"scrollbar",ref:"scrollContainer"},{default:(0,n.k6)((()=>[0===c.logMessages.length?((0,n.uX)(),(0,n.CE)("div",i,"正在加载日志...")):(0,n.Q3)("",!0),((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(c.logMessages,((e,t)=>((0,n.uX)(),(0,n.CE)("div",{key:t,class:(0,o.C4)(r.getLogLevelClass(e))},(0,o.v_)(e),3)))),128))])),_:1},512)}s(4114);var c=s(1219),r={data(){return{logMessages:[],ws:null,reconnectAttempts:0,maxReconnectAttempts:5,reconnectDelay:5e3,manualClose:!1,isReconnecting:!1,isUserScrolling:!1,hasAutoScrolled:!1}},mounted(){this.initWebSocket(),document.addEventListener("visibilitychange",this.handleVisibilityChange),this.$nextTick((()=>{const e=this.$refs.scrollContainer?.$el.querySelector(".el-scrollbar__wrap");e&&e.addEventListener("scroll",(()=>{const t=20,s=e.scrollHeight-e.scrollTop-e.clientHeight<t;this.isUserScrolling=!s}))}))},beforeUnmount(){this.closeWebSocket(),document.removeEventListener("visibilitychange",this.handleVisibilityChange)},methods:{getLogLevelClass(e){return e.includes("ERROR")?"error-log":e.includes("WARN")?"warn-log":"info-log"},initWebSocket(){if(this.hasAutoScrolled=!1,this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING))return void console.log("WebSocket is already connected or connecting");if(this.isReconnecting)return void console.log("Currently reconnecting, skipping new connection attempt");this.logMessages=[],this.manualClose=!1;const e=sessionStorage.getItem("token"),t=this.$axios.defaults.baseURL.replace(/^http/,"ws").replaceAll("/api",""),s=`${t}/logs?token=${e}`;this.ws=new WebSocket(s),this.ws.onopen=()=>{console.log("WebSocket connected"),(0,c.nk)({message:"WebSocket 连接成功，开始实时推送日志",type:"success",duration:2e3}),this.reconnectAttempts=0,this.isReconnecting=!1,this.startHeartbeat()},this.ws.onmessage=e=>{const t=e.data;this.logMessages.push(t),this.logMessages.length>200&&this.logMessages.shift(),this.$nextTick((()=>{setTimeout((()=>{const e=this.$refs.scrollContainer?.$el.querySelector(".el-scrollbar__wrap");if(!e)return;const t=20,s=e.scrollHeight-e.scrollTop-e.clientHeight<t;this.isUserScrolling&&!s||(e.scrollTop=e.scrollHeight)}),100)}))},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.handleReconnect()},this.ws.onclose=e=>{console.warn("WebSocket closed:",e),this.stopHeartbeat(),this.manualClose||this.handleReconnect()}},scrollToBottom(e=!1){this.$nextTick((()=>{const t=this.$refs.scrollContainer;if(!t||"function"!==typeof t.setScrollTop)return;const s=t.$el.querySelector(".el-scrollbar__wrap");if(!s)return;const n=20,o=s.scrollHeight-s.scrollTop-s.clientHeight<n;(e||o)&&t.setScrollTop(s.scrollHeight)}))},closeWebSocket(){this.ws&&(this.manualClose=!0,this.stopHeartbeat(),this.ws.close(),this.ws=null),this.logMessages=[]},startHeartbeat(){this.heartbeatInterval||(this.heartbeatInterval=setInterval((()=>{this.ws.readyState===WebSocket.OPEN&&this.ws.send("ping")}),3e4))},stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)},handleReconnect(){this.isReconnecting||"hidden"===document.visibilityState?console.warn("Already reconnecting or page is hidden, skipping reconnect..."):this.reconnectAttempts>=this.maxReconnectAttempts?console.error("Max reconnect attempts reached. Giving up."):(this.isReconnecting=!0,setTimeout((()=>{this.reconnectAttempts++,console.log(`Reconnecting... (Attempt ${this.reconnectAttempts})`),this.initWebSocket()}),this.reconnectDelay))},handleVisibilityChange(){"hidden"===document.visibilityState?this.closeWebSocket():"visible"===document.visibilityState&&this.initWebSocket()}}},a=s(1241);const h=(0,a.A)(r,[["render",l],["__scopeId","data-v-709ab8c5"]]);var g=h}}]);
//# sourceMappingURL=815.5da933fe.js.map