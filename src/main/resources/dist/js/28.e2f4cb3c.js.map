{"version":3,"file":"js/28.e2f4cb3c.js","mappings":"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","sources":["webpack://oci-help-web/./src/components/log/OciLog.vue","webpack://oci-help-web/./src/components/log/OciLog.vue?4506"],"sourcesContent":["<template>\r\n  <el-scrollbar class=\"scrollbar\" ref=\"scrollContainer\">\r\n    <div v-if=\"logMessages.length === 0\" style=\"color: #ffdd00;\">正在加载日志...</div>\r\n    <div\r\n        v-for=\"(log, index) in logMessages\"\r\n        :key=\"index\"\r\n        :class=\"getLogLevelClass(log)\"\r\n    >\r\n      {{ log }}\r\n    </div>\r\n  </el-scrollbar>\r\n</template>\r\n\r\n<script>\r\nimport {ElMessage} from 'element-plus';\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      logMessages: [],\r\n      ws: null,\r\n      reconnectAttempts: 0,\r\n      maxReconnectAttempts: 5,\r\n      reconnectDelay: 5000,\r\n      manualClose: false,\r\n      isReconnecting: false,\r\n      isUserScrolling: false,\r\n      hasAutoScrolled: false,\r\n    };\r\n  },\r\n  mounted() {\r\n    this.initWebSocket();\r\n    document.addEventListener('visibilitychange', this.handleVisibilityChange);\r\n    this.$nextTick(() => {\r\n      const container = this.$refs.scrollContainer?.$el.querySelector('.el-scrollbar__wrap');\r\n      if (container) {\r\n        container.addEventListener('scroll', () => {\r\n          const threshold = 20;\r\n          const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < threshold;\r\n          this.isUserScrolling = !isAtBottom;\r\n        });\r\n      }\r\n    });\r\n  },\r\n  beforeUnmount() {\r\n    this.closeWebSocket();\r\n    document.removeEventListener('visibilitychange', this.handleVisibilityChange);\r\n  },\r\n  methods: {\r\n    getLogLevelClass(log) {\r\n      if (log.includes('ERROR')) return 'error-log';\r\n      if (log.includes('WARN')) return 'warn-log';\r\n      return 'info-log';\r\n    },\r\n    initWebSocket() {\r\n      this.hasAutoScrolled = false;\r\n\r\n      if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) {\r\n        console.log('WebSocket is already connected or connecting');\r\n        return;\r\n      }\r\n\r\n      if (this.isReconnecting) {\r\n        console.log('Currently reconnecting, skipping new connection attempt');\r\n        return;\r\n      }\r\n\r\n      this.logMessages = [];\r\n      this.manualClose = false;\r\n      const token = sessionStorage.getItem('token');\r\n\r\n      const baseURL = this.$axios.defaults.baseURL.replace(/^http/, 'ws').replaceAll('/api', '');\r\n      const wsURL = `${baseURL}/logs?token=${token}`;\r\n\r\n      this.ws = new WebSocket(wsURL);\r\n\r\n      this.ws.onopen = () => {\r\n        console.log('WebSocket connected');\r\n        ElMessage({\r\n          message: 'WebSocket 连接成功，开始实时推送日志',\r\n          type: 'success',\r\n          duration: 2000 // 设置提示显示时间，单位是毫秒\r\n        });\r\n        this.reconnectAttempts = 0;\r\n        this.isReconnecting = false;\r\n        this.startHeartbeat();\r\n      };\r\n\r\n      this.ws.onmessage = (event) => {\r\n        const message = event.data;\r\n        // if (!this.logMessages.includes(message)) {\r\n        this.logMessages.push(message);\r\n        // }\r\n        if (this.logMessages.length > 200) {\r\n          this.logMessages.shift();\r\n        }\r\n\r\n        this.$nextTick(() => {\r\n          setTimeout(() => {\r\n            if (!this.hasAutoScrolled) {\r\n              const container = this.$refs.scrollContainer?.$el.querySelector('.el-scrollbar__wrap');\r\n              if (container) {\r\n                container.scrollTop = container.scrollHeight;\r\n              }\r\n              this.hasAutoScrolled = true;\r\n            } else {\r\n              this.scrollToBottom(); // ✅ 后续用户若在底部则继续滚动，否则不动\r\n            }\r\n          }, 10);\r\n        });\r\n      };\r\n\r\n      this.ws.onerror = (error) => {\r\n        console.error('WebSocket error:', error);\r\n        this.handleReconnect();\r\n      };\r\n\r\n      this.ws.onclose = (event) => {\r\n        console.warn('WebSocket closed:', event);\r\n        this.stopHeartbeat();\r\n        if (!this.manualClose) {\r\n          this.handleReconnect();\r\n        }\r\n      };\r\n    },\r\n    scrollToBottom(force = false) {\r\n      this.$nextTick(() => {\r\n        const container = this.$refs.scrollContainer?.$el.querySelector('.el-scrollbar__wrap');\r\n        if (container) {\r\n          const threshold = 20; // 距底部小于 20px 视为在底部\r\n          const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < threshold;\r\n\r\n          if (force || isAtBottom) {\r\n            container.scrollTop = container.scrollHeight;\r\n          }\r\n        }\r\n      });\r\n    },\r\n    closeWebSocket() {\r\n      if (this.ws) {\r\n        this.manualClose = true;\r\n        this.stopHeartbeat();\r\n        this.ws.close();\r\n        this.ws = null;\r\n      }\r\n      this.logMessages = [];\r\n    },\r\n    startHeartbeat() {\r\n      if (!this.heartbeatInterval) {\r\n        this.heartbeatInterval = setInterval(() => {\r\n          if (this.ws.readyState === WebSocket.OPEN) {\r\n            this.ws.send('ping');\r\n          }\r\n        }, 30000);\r\n      }\r\n    },\r\n    stopHeartbeat() {\r\n      if (this.heartbeatInterval) {\r\n        clearInterval(this.heartbeatInterval);\r\n        this.heartbeatInterval = null;\r\n      }\r\n    },\r\n    handleReconnect() {\r\n      if (this.isReconnecting || document.visibilityState === 'hidden') {\r\n        console.warn('Already reconnecting or page is hidden, skipping reconnect...');\r\n        return;\r\n      }\r\n\r\n      if (this.reconnectAttempts >= this.maxReconnectAttempts) {\r\n        console.error('Max reconnect attempts reached. Giving up.');\r\n        return;\r\n      }\r\n\r\n      this.isReconnecting = true;\r\n      setTimeout(() => {\r\n        this.reconnectAttempts++;\r\n        console.log(`Reconnecting... (Attempt ${this.reconnectAttempts})`);\r\n        this.initWebSocket();\r\n      }, this.reconnectDelay);\r\n    },\r\n    handleVisibilityChange() {\r\n      if (document.visibilityState === 'hidden') {\r\n        console.log('Page hidden, closing WebSocket...');\r\n        this.stopHeartbeat();\r\n        this.closeWebSocket();\r\n      } else if (document.visibilityState === 'visible') {\r\n        console.log('Page visible, reconnecting WebSocket...');\r\n        this.initWebSocket();\r\n      }\r\n    },\r\n  },\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.scrollbar {\r\n  height: 100%;\r\n  border: 1px solid #2d2d2d;\r\n  padding: 10px;\r\n  background-color: #1e1e1e;\r\n  color: #c5c6c7;\r\n  font-family: 'Courier New', Courier, monospace;\r\n  overflow-y: auto;\r\n}\r\n\r\n.info-log {\r\n  color: #c5c6c7;\r\n}\r\n\r\n.warn-log {\r\n  //background-color: #ffffcc;\r\n  color: #ffdd00;\r\n  //padding: 5px;\r\n  //border-radius: 4px;\r\n}\r\n\r\n.error-log {\r\n  //background-color: #ffcccc;\r\n  color: #ff0000;\r\n  //padding: 5px;\r\n  //border-radius: 4px;\r\n}\r\n</style>\r\n","import { render } from \"./OciLog.vue?vue&type=template&id=3a99317c&scoped=true\"\nimport script from \"./OciLog.vue?vue&type=script&lang=js\"\nexport * from \"./OciLog.vue?vue&type=script&lang=js\"\n\nimport \"./OciLog.vue?vue&type=style&index=0&id=3a99317c&scoped=true&lang=css\"\n\nimport exportComponent from \"../../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render],['__scopeId',\"data-v-3a99317c\"]])\n\nexport default __exports__"],"names":["key","style","_createBlock","_component_el_scrollbar","class","ref","default","_withCtx","$data","logMessages","length","_createElementBlock","_hoisted_1","_createCommentVNode","_Fragment","_renderList","log","index","_normalizeClass","$options","getLogLevelClass","_","data","ws","reconnectAttempts","maxReconnectAttempts","reconnectDelay","manualClose","isReconnecting","isUserScrolling","hasAutoScrolled","mounted","this","initWebSocket","document","addEventListener","handleVisibilityChange","$nextTick","container","$refs","scrollContainer","$el","querySelector","threshold","isAtBottom","scrollHeight","scrollTop","clientHeight","beforeUnmount","closeWebSocket","removeEventListener","methods","includes","readyState","WebSocket","OPEN","CONNECTING","console","token","sessionStorage","getItem","baseURL","$axios","defaults","replace","replaceAll","wsURL","onopen","ElMessage","message","type","duration","startHeartbeat","onmessage","event","push","shift","setTimeout","scrollToBottom","onerror","error","handleReconnect","onclose","warn","stopHeartbeat","force","close","heartbeatInterval","setInterval","send","clearInterval","visibilityState","__exports__","render"],"sourceRoot":""}