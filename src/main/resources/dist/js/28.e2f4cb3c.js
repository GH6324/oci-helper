"use strict";(self["webpackChunkoci_help_web"]=self["webpackChunkoci_help_web"]||[]).push([[28],{7028:function(e,t,s){s.r(t),s.d(t,{default:function(){return g}});var o=s(6768),n=s(4232);const i={key:0,style:{color:"#ffdd00"}};function l(e,t,s,l,c,r){const a=(0,o.g2)("el-scrollbar");return(0,o.uX)(),(0,o.Wv)(a,{class:"scrollbar",ref:"scrollContainer"},{default:(0,o.k6)((()=>[0===c.logMessages.length?((0,o.uX)(),(0,o.CE)("div",i,"正在加载日志...")):(0,o.Q3)("",!0),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(c.logMessages,((e,t)=>((0,o.uX)(),(0,o.CE)("div",{key:t,class:(0,n.C4)(r.getLogLevelClass(e))},(0,n.v_)(e),3)))),128))])),_:1},512)}s(4114);var c=s(1219),r={data(){return{logMessages:[],ws:null,reconnectAttempts:0,maxReconnectAttempts:5,reconnectDelay:5e3,manualClose:!1,isReconnecting:!1,isUserScrolling:!1,hasAutoScrolled:!1}},mounted(){this.initWebSocket(),document.addEventListener("visibilitychange",this.handleVisibilityChange),this.$nextTick((()=>{const e=this.$refs.scrollContainer?.$el.querySelector(".el-scrollbar__wrap");e&&e.addEventListener("scroll",(()=>{const t=20,s=e.scrollHeight-e.scrollTop-e.clientHeight<t;this.isUserScrolling=!s}))}))},beforeUnmount(){this.closeWebSocket(),document.removeEventListener("visibilitychange",this.handleVisibilityChange)},methods:{getLogLevelClass(e){return e.includes("ERROR")?"error-log":e.includes("WARN")?"warn-log":"info-log"},initWebSocket(){if(this.hasAutoScrolled=!1,this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING))return void console.log("WebSocket is already connected or connecting");if(this.isReconnecting)return void console.log("Currently reconnecting, skipping new connection attempt");this.logMessages=[],this.manualClose=!1;const e=sessionStorage.getItem("token"),t=this.$axios.defaults.baseURL.replace(/^http/,"ws").replaceAll("/api",""),s=`${t}/logs?token=${e}`;this.ws=new WebSocket(s),this.ws.onopen=()=>{console.log("WebSocket connected"),(0,c.nk)({message:"WebSocket 连接成功，开始实时推送日志",type:"success",duration:2e3}),this.reconnectAttempts=0,this.isReconnecting=!1,this.startHeartbeat()},this.ws.onmessage=e=>{const t=e.data;this.logMessages.push(t),this.logMessages.length>200&&this.logMessages.shift(),this.$nextTick((()=>{setTimeout((()=>{if(this.hasAutoScrolled)this.scrollToBottom();else{const e=this.$refs.scrollContainer?.$el.querySelector(".el-scrollbar__wrap");e&&(e.scrollTop=e.scrollHeight),this.hasAutoScrolled=!0}}),10)}))},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.handleReconnect()},this.ws.onclose=e=>{console.warn("WebSocket closed:",e),this.stopHeartbeat(),this.manualClose||this.handleReconnect()}},scrollToBottom(e=!1){this.$nextTick((()=>{const t=this.$refs.scrollContainer?.$el.querySelector(".el-scrollbar__wrap");if(t){const s=20,o=t.scrollHeight-t.scrollTop-t.clientHeight<s;(e||o)&&(t.scrollTop=t.scrollHeight)}}))},closeWebSocket(){this.ws&&(this.manualClose=!0,this.stopHeartbeat(),this.ws.close(),this.ws=null),this.logMessages=[]},startHeartbeat(){this.heartbeatInterval||(this.heartbeatInterval=setInterval((()=>{this.ws.readyState===WebSocket.OPEN&&this.ws.send("ping")}),3e4))},stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)},handleReconnect(){this.isReconnecting||"hidden"===document.visibilityState?console.warn("Already reconnecting or page is hidden, skipping reconnect..."):this.reconnectAttempts>=this.maxReconnectAttempts?console.error("Max reconnect attempts reached. Giving up."):(this.isReconnecting=!0,setTimeout((()=>{this.reconnectAttempts++,console.log(`Reconnecting... (Attempt ${this.reconnectAttempts})`),this.initWebSocket()}),this.reconnectDelay))},handleVisibilityChange(){"hidden"===document.visibilityState?(console.log("Page hidden, closing WebSocket..."),this.stopHeartbeat(),this.closeWebSocket()):"visible"===document.visibilityState&&(console.log("Page visible, reconnecting WebSocket..."),this.initWebSocket())}}},a=s(1241);const h=(0,a.A)(r,[["render",l],["__scopeId","data-v-3a99317c"]]);var g=h}}]);
//# sourceMappingURL=28.e2f4cb3c.js.map