<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" href="favicon.ico" type="image/x-icon"/>
    <title>IP信息查询</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" crossorigin/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js" crossorigin></script>
</head>

<body>
<button id="theme-toggle" title="切换到暗黑模式" aria-label="Toggle Dark Mode">🌞</button>

<main>
    <h1>IP信息查询</h1>
    <div class="input-group">
        <input type="text" id="ipInput" placeholder="请输入IP地址" onkeypress="handleKeyPress(event)">
        <button id="query-button" onclick="getIPInfo()">查询</button>
    </div>
    <div id="result"></div>
    <div id="map" style="display: none;"></div>
</main>
<script>
    window.onload = () => {
        initTheme();
        getLocalIPInfo();
    };

    // 切换主题
    const themeToggle = document.getElementById('theme-toggle');

    window.addEventListener('scroll', () => {
        if (window.scrollY === 0) {
            // 滚动到顶部时显示
            themeToggle.style.opacity = '1';
            themeToggle.style.pointerEvents = 'auto';
        } else {
            // 滚动离开顶部时隐藏
            themeToggle.style.opacity = '0';
            themeToggle.style.pointerEvents = 'none';
        }
    });

    function applyTheme(theme) {
        const isDark = theme === 'dark';
        document.body.classList.toggle('dark', isDark);
        themeToggle.textContent = isDark ? '🌙' : '🌞';
        themeToggle.title = isDark ? '切换到亮色模式' : '切换到暗黑模式';
        localStorage.setItem('theme', theme);
    }

    let currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(currentTheme);

    themeToggle.addEventListener('click', () => {
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(currentTheme);
    });

    themeToggle.addEventListener('mouseenter', () => {
        themeToggle.textContent = currentTheme === 'dark' ? '🌞' : '🌙';
    });
    themeToggle.addEventListener('mouseleave', () => {
        themeToggle.textContent = currentTheme === 'dark' ? '🌙' : '🌞';
    });

    async function getLocalIPInfo() {
        const resultDiv = document.getElementById("result");
        const mapDiv = document.getElementById("map");
        resultDiv.innerHTML = '<div class="loader"></div>';
        mapDiv.style.display = "none";

        try {
            const data = await fetch("https://speed.cloudflare.com/meta").then(res => res.json());

            // 填充ipInput框
            const ipInput = document.getElementById("ipInput");
            ipInput.value = data.clientIp || "";

            // 用同一个显示函数
            displayLocalResult(data);
        } catch (err) {
            resultDiv.innerHTML = `<h3>请求失败</h3><p><strong>错误:</strong> ${err.message}</p>`;
        }
    }

    async function getIPInfo() {
        const ip = document.getElementById("ipInput").value.trim();
        const resultDiv = document.getElementById("result");
        const mapDiv = document.getElementById("map");
        resultDiv.innerHTML = '<div class="loader"></div>';
        mapDiv.style.display = "none";

        if (!ip) return alert("请输入IP地址");
        if (!isValidIPv4(ip) && !isValidIPv6(ip)) {
            alert("请输入有效IP地址");
            resultDiv.innerHTML = "";
            return;
        }

        try {
            // 并发请求两个接口
            let [data1, data2] = await Promise.all([
                fetch(`https://ipinfo.chigua.tk/${ip}`).then(res => res.json()),
                fetch(`https://ipapi.co/${ip}/json`).then(res => res.json()),
            ]);

            if (data1.error) {
                resultDiv.innerHTML = `<h3>查询错误</h3><p><strong>错误:</strong> ${data1.error || "无效IP"}</p>`;
                return;
            }
            if (data2.error) {
                // 第二个接口错误也不阻止显示第一个接口数据，但可以提示
                data2 = {};
            }

            // 定义需要保留的字段白名单（示例字段，请根据实际需求调整）
            const PRESERVE_FIELDS = ['postal'];

            // 合并两个接口数据，第二个接口字段优先覆盖同名字段
            const mergedData = {
                ...data2, // 优先展开第二个接口的数据
                ...Object.fromEntries(
                    PRESERVE_FIELDS
                        .filter(key => key in data1)
                        .map(key => [key, data1[key]])
                )
            };

            displayQueryResult(mergedData);
        } catch (err) {
            resultDiv.innerHTML = `<h3>请求失败</h3><p><strong>错误:</strong> ${err.message}</p>`;
        }
    }

    function displayLocalResult(data) {
        const div = document.getElementById("result");
        const ipInput = document.getElementById("ipInput");
        ipInput.value = data.clientIp;
        getIPInfo()
    }

    function displayQueryResult(data) {
        const div = document.getElementById("result");
        const ipInput = document.getElementById("ipInput");
        ipInput.value = data.ip || "";

        // 经纬度用ipinfo的loc或者ipapi的latitude/longitude
        let lat = "", lng = "";
        if (data.latitude && data.longitude) {
            lat = data.latitude;
            lng = data.longitude;
        }

        if (lat === "" || lng === "") {
            if (data.loc) {
                [lat, lng] = data.loc.split(",");
            }
        }

        div.innerHTML = `
                <h3>IP查询结果</h3>
                <p><strong>IP地址:</strong> ${data.ip || "未知"}</p>
                <p><strong>网段:</strong> ${data.network || "未知"}</p>
                <p><strong>主机名:</strong> ${data.hostname || "未知"}</p>
                <p><strong>国家:</strong> ${data.country || data.country_name || "未知"}</p>
                <p><strong>地区:</strong> ${data.region || "未知"}</p>
                <p><strong>城市:</strong> ${data.city || "未知"}</p>
                <p><strong>组织:</strong> ${data.org || data.org || "未知"}</p>
                <p><strong>ASN:</strong> ${data.asn || "未知"}</p>
                <p><strong>数据中心:</strong> ${data.country_code_iso3 || "未知"}</p>
                <p><strong>电话区号:</strong> ${data.country_calling_code || "未知"}</p>
                <p><strong>货币:</strong> ${data.currency || "未知"}</p>
                <p><strong>语言:</strong> ${data.languages || "未知"}</p>
                <p><strong>邮编:</strong> ${data.postal || "未知"}</p>
                <p><strong>时区:</strong> ${data.timezone + " " + data.utc_offset || "未知"}</p>
                <p><strong>纬度:</strong> ${lat || "未知"}</p>
                <p><strong>经度:</strong> ${lng || "未知"}</p>
                <p><strong>任播:</strong> ${data.anycast ? "是" : "否"}</p>
            `;

        if (lat && lng) displayMap(parseFloat(lat), parseFloat(lng), data.city || "");
    }


    let map;

    function displayMap(lat, lng, name) {
        document.getElementById("map").style.display = "block";
        if (map) map.remove();
        map = L.map("map").setView([lat, lng], 10);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            // attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);
        L.marker([lat, lng]).addTo(map).bindPopup(`<b>${name}</b><br/>纬度: ${lat}<br/>经度: ${lng}`).openPopup();
    }

    function isValidIPv4(ip) {
        return /^(\d{1,3}\.){3}\d{1,3}$/.test(ip);
    }

    function isValidIPv6(ip) {
        return /:/.test(ip);
    }

    function handleKeyPress(e) {
        if (e.key === "Enter") getIPInfo();
    }

    function handleInvalidParameter(res) {
        document.getElementById("result").innerHTML = `<h3>查询错误</h3><p><strong>错误:</strong> ${res.error || "无效IP"}</p>`;
    }

    function handleRequestError(err) {
        document.getElementById("result").innerHTML = `<h3>请求失败</h3><p><strong>错误:</strong> ${err.message}</p>`;
    }

    function toggleTheme() {
        document.body.classList.toggle("dark");
        localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    function initTheme() {
        const saved = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        if (saved === "dark" || (!saved && prefersDark)) document.body.classList.add("dark");
    }
</script>
</body>
<style>
    :root {
        --bg-color: #ffffff;
        --text-color: #1a1a1a;
        --card-bg: #f9fbfd;
        --button-bg: #007bff;
        --button-text: #ffffff;
        --input-bg: #fff;
        --border-color: #ccc;
    }

    body.dark {
        --bg-color: #121212;
        --text-color: #f0f0f0;
        --card-bg: #1e1e1e;
        --button-bg: #3399ff;
        --button-text: #ffffff;
        --input-bg: #1e1e1e;
        --border-color: #444;
    }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }

    main {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background-color: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
        transition: background-color 0.3s, color 0.3s;
    }

    h1 {
        text-align: center;
        font-size: 28px;
        margin-bottom: 20px;
    }

    .input-group {
        display: flex;
        margin: 0 auto 20px auto;
        box-shadow: 0 0 0 1px var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    #ipInput {
        flex: 1;
        padding: 12px 16px;
        font-size: 16px;
        border: none;
        outline: none;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    #query-button {
        padding: 0 20px;
        font-size: 16px;
        background-color: var(--button-bg);
        color: var(--button-text);
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    #query-button:hover {
        background-color: #005ec4;
    }

    #result {
        margin-top: 20px;
        padding: 20px 25px;
        background-color: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #result h3 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 20px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 8px;
    }

    #result p {
        margin: 10px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid #eaeaea;
        font-size: 15px;
    }

    #result strong {
        display: inline-block;
        width: 90px;
    }

    #map {
        width: 100%;
        height: 400px;
        margin-top: 25px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.05);
    }

    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 0.8s linear infinite;
        margin: 20px auto;
    }

    body.dark {
        background-color: #1e1e1e;
        color: #f0f0f0;
        transition: background-color 0.3s, color 0.3s;
    }

    #theme-toggle {
        position: fixed;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        z-index: 9999;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #theme-toggle:hover {
        transform: scale(1.2);
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

</html>